<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Веско-AI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary-100: #e0e8ff;
      --primary-200: #c2d1ff;
      --primary-300: #a3b9ff;
      --primary-400: #85a2ff;
      --primary-500: #668bff;
      --primary-600: #4d6bcc;
      --primary-700: #334c99;
      --primary-800: #1a2e66;
      --primary-900: #0a1533;
      --secondary-100: #e6f0ff;
      --secondary-200: #cce1ff;
      --secondary-300: #b3d2ff;
      --secondary-400: #99c3ff;
      --secondary-500: #80b5ff;
      --secondary-600: #6690cc;
      --secondary-700: #4d6c99;
      --secondary-800: #334866;
      --secondary-900: #1a2433;
      --accent-100: #e6f5ff;
      --accent-200: #ccebff;
      --accent-300: #b3e0ff;
      --accent-400: #99d6ff;
      --accent-500: #80ccff;
      --accent-600: #66a3cc;
      --accent-700: #4d7a99;
      --accent-800: #335266;
      --accent-900: #1a2933;
      --dark-bg: #1a1a2e;
      --light-bg: #f8f9fa;
      --user-msg-bg: #e3f2fd;
      --bot-msg-bg: #e6f0ff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--secondary-100) 0%, var(--primary-100) 100%);
      height: 100vh;
      display: flex;
      flex-direction: column;
      transition: all 0.5s ease;
    }

    body.dark-mode {
      background: linear-gradient(135deg, var(--dark-bg) 0%, #16213e 100%);
      color: #fff;
    }

    .header {
      background: linear-gradient(90deg, var(--primary-500) 0%, var(--accent-500) 100%);
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 10;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        to bottom right,
        rgba(255,255,255,0.3) 0%,
        rgba(255,255,255,0) 60%
      );
      transform: rotate(30deg);
      animation: shimmer 8s infinite linear;
    }

    @keyframes shimmer {
      0% { transform: rotate(30deg) translate(-10%, -10%); }
      100% { transform: rotate(30deg) translate(10%, 10%); }
    }

    .header h1 {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      position: relative;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .theme-toggle, .settings-btn, .chat-menu-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .theme-toggle:hover, .settings-btn:hover, .chat-menu-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .theme-toggle:active, .settings-btn:active, .chat-menu-btn:active {
      transform: translateY(0);
    }

    .controls {
      display: flex;
      gap: 1rem;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      padding: 1rem;
      height: calc(100vh - 70px);
    }

    .chat-container {
      display: flex;
      flex: 1;
      gap: 1rem;
      overflow: hidden;
    }

    .chat-sidebar {
      width: 250px;
      background: rgba(255,255,255,0.8);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      transform: translateX(0);
    }

    body.dark-mode .chat-sidebar {
      background: rgba(40, 44, 52, 0.9);
    }

    .chat-sidebar.hidden {
      transform: translateX(-100%);
      width: 0;
      padding: 0;
      opacity: 0;
    }

    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .chat-sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    body.dark-mode .chat-sidebar-header {
      border-bottom-color: rgba(255,255,255,0.1);
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 1rem;
    }

    .chat-item {
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .chat-item:hover {
      background: rgba(102, 139, 255, 0.1);
    }

    .chat-item.active {
      background: rgba(102, 139, 255, 0.2);
      font-weight: bold;
    }

    body.dark-mode .chat-item:hover {
      background: rgba(128, 204, 255, 0.1);
    }

    body.dark-mode .chat-item.active {
      background: rgba(128, 204, 255, 0.2);
    }

    .chat-item-actions {
      display: none;
      position: absolute;
      right: 10px;
      background: white;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 1;
    }

    body.dark-mode .chat-item-actions {
      background: #2d3748;
    }

    .chat-item:hover .chat-item-actions {
      display: flex;
    }

    .chat-item-action {
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      color: var(--primary-500);
    }

    body.dark-mode .chat-item-action {
      color: var(--accent-400);
    }

    .chat-item-action:hover {
      background: rgba(102, 139, 255, 0.1);
    }

    body.dark-mode .chat-item-action:hover {
      background: rgba(128, 204, 255, 0.1);
    }

    .new-chat-btn {
      background: var(--primary-500);
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-weight: 500;
      width: 100%;
    }

    .new-chat-btn:hover {
      background: var(--primary-600);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      scroll-behavior: smooth;
      margin-bottom: 1rem;
      transition: background-color 0.3s ease;
    }

    body.dark-mode #messages {
      background-color: rgba(40, 44, 52, 0.9);
    }

    .message {
      display: flex;
      margin-bottom: 1rem;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      flex-shrink: 0;
      background: linear-gradient(135deg, var(--primary-400) 0%, var(--accent-400) 100%);
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .message-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .user-avatar {
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-300) 100%);    
    }

    .bot-avatar {
      background: linear-gradient(135deg, var(--accent-500) 0%, var(--accent-300) 100%);
    }

    .message-content {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 18px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
      transition: all 0.3s ease;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message-content:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .user .message-content {
      background-color: var(--user-msg-bg);
      border-bottom-right-radius: 5px;
      margin-left: auto;
      color: #333;
    }

    .bot .message-content {
      background-color: var(--bot-msg-bg);
      border-bottom-left-radius: 5px;
      color: #333;
    }

    body.dark-mode .user .message-content {
      background: linear-gradient(135deg, rgba(67, 56, 202, 0.3) 0%, rgba(79, 70, 229, 0.3) 100%);
      color: white;
    }

    body.dark-mode .bot .message-content {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
      color: white;
    }

    .message-time {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 0.3rem;
      text-align: right;
    }

    body.dark-mode .message-time {
      color: #d1d5db;
    }

    .input-area {
      display: flex;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 0.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    body.dark-mode .input-area {
      background-color: rgba(40, 44, 52, 0.9);
    }

    #chat-form {
      display: flex;
      width: 100%;
      gap: 0.5rem;
    }

    .input-wrapper {
      position: relative;
      flex: 1;
    }

    #userinput {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 20px;
      background-color: white;
      transition: all 0.3s ease;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      resize: none;
      min-height: 40px;
      max-height: 120px;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    body.dark-mode #userinput {
      background-color: #2d3748;
      border-color: #4a5568;
      color: white;
    }

    #userinput:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(102, 139, 255, 0.2);
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    button {
      border: none;
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--accent-500) 100%);
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    button:active {
      transform: translateY(0);
    }

    .send-btn {
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--accent-500) 100%);
    }

    .voice-btn {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    .settings-panel {
      position: fixed;
      top: 70px;
      right: -300px;
      width: 300px;
      height: calc(100vh - 70px);
      background-color: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      transition: right 0.3s ease;
      z-index: 1000;
      padding: 1rem;
      overflow-y: auto;
    }

    body.dark-mode .settings-panel {
      background-color: #2d3748;
      color: white;
    }

    .settings-panel.active {
      right: 0;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    body.dark-mode .settings-header {
      border-bottom-color: #4a5568;
    }

    .close-settings {
      background: transparent;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: #6b7280;
    }

    body.dark-mode .close-settings {
      color: #d1d5db;
    }

    .setting-item {
      margin-bottom: 1rem;
    }

    .setting-item label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .setting-item select, .setting-item input {
      width: 100%;
      padding: 0.5rem;
      border-radius: 5px;
      border: 1px solid #e5e7eb;
      background-color: white;
    }

    body.dark-mode .setting-item select,
    body.dark-mode .setting-item input {
      background-color: #374151;
      border-color: #4b5563;
      color: white;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: none;
      z-index: 990;
    }

    .overlay.active {
      display: block;
    }

    .typing-indicator {
      display: none;
      padding: 0.5rem 1rem;
      background-color: rgba(255,255,255,0.7);
      border-radius: 10px;
      margin-bottom: 1rem;
      animation: pulse 1.5s infinite;
    }

    body.dark-mode .typing-indicator {
      background-color: rgba(40, 44, 52, 0.7);
      color: white;
    }

    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background-color: var(--primary-500);
      border-radius: 50%;
      display: inline-block;
      margin-right: 3px;
      animation: bounce 1.5s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .clear-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      font-size: 16px;
      height: 20px;
      width: 20px;
      margin: 0;
      padding: 0;
      display: none;
    }

    #userinput:not(:placeholder-shown) + .clear-btn {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .copy-btn {
      position: absolute;
      right: 5px;
      top: 5px;
      background: transparent;
      border: none;
      color: #6b7280;
      cursor: pointer;
      width: 25px;
      height: 25px;
      font-size: 12px;
      padding: 0;
      margin: 0;
      opacity: 0;
      transition: opacity 0.2s;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .message-content:hover .copy-btn {
      opacity: 0.7;
    }

    .copy-btn:hover {
      opacity: 1 !important;
      background-color: rgba(0,0,0,0.1);
    }

    body.dark-mode .copy-btn:hover {
      background-color: rgba(255,255,255,0.1);
    }

    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .suggestion {
      background-color: rgba(255,255,255,0.8);
      border: 1px solid #e5e7eb;
      border-radius: 15px;
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    body.dark-mode .suggestion {
      background-color: rgba(40, 44, 52, 0.8);
      border-color: #4b5563;
      color: #d1d5db;
    }

    .suggestion:hover {
      background-color: var(--primary-500);
      color: white;
      border-color: var(--primary-500);
      transform: translateY(-2px);
    }

    body.dark-mode .suggestion:hover {
      background-color: var(--accent-500);
      border-color: var(--accent-500);
    }

    .speech-recognition-active {
      animation: pulse-border 2s infinite;
    }

    @keyframes pulse-border {
      0% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
      }
    }

    .error-message {
      color: #721c24;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      animation: shake 0.5s;
    }

    body.dark-mode .error-message {
      background-color: #380a0f;
      border-color: #721c24;
      color: #f8d7da;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }

    code {
      font-family: 'Consolas', 'Monaco', monospace;
      background-color: rgba(0,0,0,0.05);
      padding: 2px 4px;
      border-radius: 3px;
      color: #d63384;
    }

    body.dark-mode code {
      background-color: rgba(255,255,255,0.1);
      color: #f687b3;
    }

    pre {
      background-color: rgba(0,0,0,0.05);
      padding: 1rem;
      border-radius: 5px;
      overflow-x: auto;
      margin: 0.5rem 0;
      font-family: 'Consolas', 'Monaco', monospace;
      position: relative;
    }

    body.dark-mode pre {
      background-color: rgba(255,255,255,0.1);
    }

    .pre-copy-btn {
      position: absolute;
      right: 5px;
      top: 5px;
      background: rgba(0,0,0,0.1);
      border: none;
      color: #6b7280;
      cursor: pointer;
      width: 25px;
      height: 25px;
      font-size: 12px;
      padding: 0;
      margin: 0;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .pre-copy-btn:hover {
      background: rgba(0,0,0,0.2);
      color: #374151;
    }

    body.dark-mode .pre-copy-btn {
      background: rgba(255,255,255,0.1);
      color: #d1d5db;
    }

    body.dark-mode .pre-copy-btn:hover {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .math-expression {
      font-family: 'Times New Roman', Times, serif;
      font-style: italic;
      color: #1e40af;
    }

    body.dark-mode .math-expression {
      color: #93c5fd;
    }

    .rename-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      z-index: 1100;
      width: 90%;
      max-width: 400px;
      display: none;
    }

    body.dark-mode .rename-modal {
      background: #2d3748;
    }

    .rename-modal.active {
      display: block;
    }

    .rename-modal h3 {
      margin-bottom: 1rem;
    }

    .rename-input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border-radius: 5px;
      border: 1px solid #e5e7eb;
    }

    body.dark-mode .rename-input {
      background-color: #374151;
      border-color: #4b5563;
      color: white;
    }

    .rename-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .rename-btn, .cancel-rename-btn {
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      
    }

    .rename-btn {
      background: var(--primary-500);
      color: #374151;
      border: none;
    }
    .rename-btn:hover {
      background: var(--primary-600);
    }

    .cancel-rename-btn {
      background: #e5e7eb;
      border: none;
      color: #374151;
    }

    body.dark-mode .cancel-rename-btn {
      background: #4b5563;
      color: white;
    }

    .cancel-rename-btn:hover {
      background: #d1d5db;
    }

    body.dark-mode .cancel-rename-btn:hover {
      background: #6b7280;
    }

    .context-menu {
      position: absolute;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 1000;
      display: none;
      min-width: 150px;
      overflow: hidden;
    }

    body.dark-mode .context-menu {
      background: #2d3748;
      border: 1px solid #4a5568;
    }

    .context-menu-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .context-menu-item:hover {
      background: rgba(102, 139, 255, 0.1);
    }

    body.dark-mode .context-menu-item:hover {
      background: rgba(128, 204, 255, 0.1);
    }

    @media (max-width: 768px) {
      .container {
        padding: 0.5rem;
        height: calc(100vh - 60px);
      }
      
      .header h1 {
        font-size: 1.2rem;
      }
      
      .message-content {
        max-width: 90%;
      }
      
      .settings-panel {
        width: 100%;
        right: -100%;
      }
      
      .settings-panel.active {
        right: 0;
      }

      .chat-sidebar {
        position: fixed;
        top: 70px;
        left: 0;
        height: calc(100vh - 70px);
        z-index: 1000;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      }

      .chat-sidebar.hidden {
        transform: translateX(-100%);
        width: 0;
        padding: 0;
        opacity: 0;
      }

      .chat-main {
        width: 100%;
      }

      .input-area {
        padding: 0.5rem;
      }

      .action-buttons {
        gap: 0.3rem;
      }

      button {
        width: 36px;
        height: 36px;
      }

      #userinput {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }

      .suggestions {
        flex-direction: column;
      }
    }

    @keyframes loadingWave {
      0%, 60%, 100% {
        transform: initial;
        background-color: rgba(102, 139, 255, 0.5);
      }
      30% {
        transform: translateY(-5px);
        background-color: var(--primary-500);
      }
    }

    .loading-wave {
      display: flex;
      gap: 5px;
      padding: 0.5rem 1rem;
      border-radius: 18px;
      background-color: var(--bot-msg-bg);
      margin-bottom: 1rem;
      width: fit-content;
    }

    body.dark-mode .loading-wave {
      background-color: rgba(102, 126, 234, 0.3);
    }

    .loading-wave-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: rgba(102, 139, 255, 0.5);
      animation: loadingWave 1.5s ease infinite;
    }

    .loading-wave-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .loading-wave-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--accent-500) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s ease;
      display: none;
    }

    .fab:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }
    
    </style>
  </head>
  <body>
    <div class="header">
      <h1><i class="fas fa-robot"></i> Веско-AI</h1>
      <div class="controls">
        <button class="chat-menu-btn tooltip" data-tooltip="История на чатове"><i class="fas fa-comments"></i></button>
        <button class="theme-toggle tooltip" data-tooltip="Смени тема"><i class="fas fa-moon"></i></button>
        <button class="settings-btn tooltip" data-tooltip="Настройки"><i class="fas fa-cog"></i></button>
      </div>
    </div>

    <div class="container">
      <div class="chat-container">
        <div class="chat-sidebar">
          <div class="chat-sidebar-header">
            <h3>История на чатове</h3>
          </div>
          <div class="chat-list" id="chat-history">
          </div>
          <button class="new-chat-btn" id="new-chat-btn">
            <i class="fas fa-plus"></i> Нов разговор
          </button>
        </div>
        
        <div class="chat-main">
          <div class="suggestions">
            <div class="suggestion">Как да избера подходящ процесор?</div>
            <div class="suggestion">Разлика между SSD и HDD</div>
            <div class="suggestion">Оптимизация на C# код</div>
            <div class="suggestion">Как работят невронните мрежи?</div>
          </div>
          
          <div id="messages">
            
          </div>

          <div class="typing-indicator">
            Веско мисли <span></span><span></span><span></span>
          </div>

          <div class="input-area">
            <form id="chat-form">
              <div class="input-wrapper">
                <textarea id="userinput" placeholder="Задайте въпрос..." autocomplete="off"></textarea>
                <button type="button" class="clear-btn"><i class="fas fa-times"></i></button>
              </div>
              <div class="action-buttons">
                <button type="button" class="voice-btn tooltip" data-tooltip="Гласово въвеждане"><i class="fas fa-microphone"></i></button>
                <button type="submit" class="send-btn tooltip" data-tooltip="Изпрати"><i class="fas fa-paper-plane"></i></button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="settings-panel">
      <div class="settings-header">
        <h3>Настройки</h3>
        <button class="close-settings"><i class="fas fa-times"></i></button>
      </div>
      <div class="setting-item">
        <label for="ai-model">AI Модел</label>
        <select id="ai-model" disabled>
          <option value="deepseek/deepseek-chat" selected>DeepSeek Chat</option>
        </select>
      </div>
      <div class="setting-item">
        <label for="system-prompt">Системен промпт</label>
        <textarea id="system-prompt" rows="8">Ти си Веско-AI, специализиран асистент в областите на компютърния хардуер, софтуера, програмирането и компютърните науки с фокус върху C#. Твоята основна цел е да предоставяш точни, дълбоки и ясни обяснения на сложни концепции в тези области. Винаги се стреми да:

  1. Обясняваш технически детайли за хардуерни компоненти (процесори, RAM, GPU, SSD и др.)
  2. Предоставяш сравнения между различни технологии и продукти
  3. Обясняваш софтуерни принципи и алгоритми с фокус върху C#
  4. Пишеш чист, ефективен и добре документиран C# код
  5. Разясняваш сложни компютърни концепции (като изкуствен интелект, блокчейн, квантови изчисления)

  Използваш формален, но достъпен език. Когато е уместно, включваш технически термини и кодови блокове с подходящ синтаксис.

  Винаги проверяваш своите отговори за точност и последователност. Ако не си сигурен в отговора, казваш че не знаеш, вместо да предоставяш невярна информация.

  Говориш на български език, но можеш да включваш технически термини на английски, когато няма добра българска алтернатива.</textarea>
      </div>
      <div class="setting-item">
        <label for="speech-voice">Глас за Speech-to-Text</label>
        <select id="speech-voice">
          <option value="">Избери глас</option>
          <option value="Microsoft Ivan Desktop - Bulgarian" selected>Иван (Български)</option>
        </select>
      </div>
    </div>
    
    <div class="rename-modal" id="rename-modal">
      <h3>Преименувай разговор</h3>
      <input type="text" class="rename-input" id="rename-input" placeholder="Въведи ново име">
      <div class="rename-actions">
        <button class="cancel-rename-btn" id="cancel-rename-btn">Отказ</button>
        <button class="rename-btn" id="rename-btn">Запази</button>
      </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <div class="context-menu" id="context-menu">
      <div class="context-menu-item" id="read-aloud-btn">
        <i class="fas fa-volume-up"></i> Прочети с глас
      </div>
    </div>

    <div class="fab" id="mobile-menu-btn">
      <i class="fas fa-comments"></i>
    </div>

    <script>
      const API_KEY = "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";
  const chatForm = document.getElementById("chat-form");
  const userInput = document.getElementById("userinput");
  const chatBox = document.getElementById("messages");
  const sendButton = document.querySelector(".send-btn");
  const voiceButton = document.querySelector(".voice-btn");
  const themeToggle = document.querySelector(".theme-toggle");
  const settingsBtn = document.querySelector(".settings-btn");
  const chatMenuBtn = document.querySelector(".chat-menu-btn");
  const settingsPanel = document.querySelector(".settings-panel");
  const closeSettings = document.querySelector(".close-settings");
  const overlay = document.getElementById("overlay");
  const clearBtn = document.querySelector(".clear-btn");
  const suggestions = document.querySelectorAll(".suggestion");
  const typingIndicator = document.querySelector(".typing-indicator");
  const systemPromptInput = document.getElementById("system-prompt");
  const speechVoiceSelect = document.getElementById("speech-voice");
  const chatSidebar = document.querySelector(".chat-sidebar");
  const chatHistoryContainer = document.getElementById("chat-history");
  const newChatBtn = document.getElementById("new-chat-btn");
  const renameModal = document.getElementById("rename-modal");
  const renameInput = document.getElementById("rename-input");
  const renameBtn = document.getElementById("rename-btn");
  const cancelRenameBtn = document.getElementById("cancel-rename-btn");
  const mobileMenuBtn = document.getElementById("mobile-menu-btn");
  const contextMenu = document.getElementById("context-menu");
  const readAloudBtn = document.getElementById("read-aloud-btn");

  let currentChatId = null;
  let chatHistory = {};
  let isTemporaryChat = false;
  let currentChatBeingRenamed = null;
  let lastRightClickedMessage = null;

  function init() {
    addStyles();
    loadTheme();
    loadChatHistory();
    setupEventListeners();
    setupCopyButtons();
    userInput.focus();
  }

  function addStyles() {
    const styleElement = document.createElement('style');
    styleElement.textContent = `
      .message-content-wrapper {
        display: flex;
        flex-direction: column;
        width: 100%;
        position: relative;
      }
      
      .message-content {
        white-space: pre-wrap;
        word-break: break-word;
      }
      
      .message-time-container {
        display: flex;
        justify-content: flex-end;
        width: 100%;
        margin-top: 4px;
      }
      
      .message-time {
        font-size: 0.8em;
        color: #888;
        margin-top: 2px;
      }
      
      .copy-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        opacity: 0.7;
        z-index: 10;
        cursor: pointer;
        background: transparent;
        border: none;
        color: inherit;
      }
      
      .copy-btn:hover {
        opacity: 1;
      }
      
      pre {
        white-space: pre-wrap;
        position: relative;
        overflow-x: auto;
      }
      
      pre code {
        display: block;
        padding: 10px;
      }
      
      .pre-copy-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: transparent;
        border: none;
        cursor: pointer;
        color: inherit;
        opacity: 0.7;
        z-index: 10;
      }
      
      .pre-copy-btn:hover {
        opacity: 1;
      }
    `;
    document.head.appendChild(styleElement);
  }

  function loadTheme() {
    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark-mode");
      themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
  }

  function loadChatHistory() {
    const savedChats = localStorage.getItem("chatHistory");
    if (savedChats) {
      chatHistory = JSON.parse(savedChats);
      renderChatHistory();
      }
      else {
      createNewChat();
    }
  }

  function renderChatHistory() {
    chatHistoryContainer.innerHTML = '';
    
    const chatIds = Object.keys(chatHistory).sort((a, b) => {
      return new Date(chatHistory[b].createdAt) - new Date(chatHistory[a].createdAt);
    });
    
    chatIds.forEach(chatId => {
      const chat = chatHistory[chatId];
      const chatItem = document.createElement("div");
      chatItem.className = `chat-item ${currentChatId === chatId ? 'active' : ''}`;
      chatItem.innerHTML = `
        <span>${chat.title}</span>
        <div class="chat-item-actions">
          <div class="chat-item-action rename-chat" data-chat-id="${chatId}">
            <i class="fas fa-edit"></i>
          </div>
          <div class="chat-item-action delete-chat" data-chat-id="${chatId}">
            <i class="fas fa-trash"></i>
          </div>
        </div>
      `;
      
      chatItem.addEventListener("click", () => loadChat(chatId));
      
      chatItem.querySelector(".rename-chat").addEventListener("click", (e) => {
        e.stopPropagation();
        showRenameModal(chatId);
      });
      
      chatItem.querySelector(".delete-chat").addEventListener("click", (e) => {
        e.stopPropagation();
        deleteChat(chatId);
      });
      
      chatHistoryContainer.appendChild(chatItem);
    });
  }

  function createNewChat(isTemp = false) {
    const chatId = Date.now().toString();
    isTemporaryChat = isTemp;
    
    chatHistory[chatId] = {
      id: chatId,
      title: isTemp ? "Временен разговор" : `Нов разговор ${Object.keys(chatHistory).length + 1}`,
      messages: [],
      createdAt: new Date().toISOString(),
      isTemp: isTemp
    };
    
    if (!isTemp) {
      saveChatHistory();
    }
    
    loadChat(chatId);
    return chatId;
  }

  function loadChat(chatId) {
    if (!chatHistory[chatId]) return;
    
    currentChatId = chatId;
    isTemporaryChat = chatHistory[chatId].isTemp || false;
    
    chatBox.innerHTML = '';
    
    const messages = chatHistory[chatId].messages;
    if (messages.length === 0) {
      return;
    }
    
    messages.forEach(msg => {
      if (msg.role !== 'system') {
        showMessage(msg.content, msg.role === 'user' ? 'user' : 'bot', false);
      }
    });   
    
    document.querySelectorAll('.chat-item').forEach(item => {
      item.classList.remove('active');
      if (item.querySelector(`[data-chat-id="${chatId}"]`)) {
        item.classList.add('active');
      }
    });
    
    chatBox.scrollTop = chatBox.scrollHeight;
    
    setupCopyButtons();
  }

  function saveChatHistory() {
    const chatsToSave = {};
    
    for (const chatId in chatHistory) {
      if (!chatHistory[chatId].isTemp) {
        chatsToSave[chatId] = chatHistory[chatId];
      }
    }
    
    localStorage.setItem("chatHistory", JSON.stringify(chatsToSave));
    renderChatHistory();
  }

  function deleteChat(chatId) {
    if (!confirm("Сигурни ли сте, че искате да изтриете този разговор?")) return;
    
    delete chatHistory[chatId];
    
    if (currentChatId === chatId) {
      createNewChat();
    }
    
    saveChatHistory();
  }

  function renameChat(chatId, newTitle) {
    if (!chatHistory[chatId] || !newTitle.trim()) return;
    
    chatHistory[chatId].title = newTitle.trim();
    saveChatHistory();
    hideRenameModal();
  }

  function showRenameModal(chatId) {
    currentChatBeingRenamed = chatId;
    renameInput.value = chatHistory[chatId].title;
    renameModal.classList.add('active');
    overlay.classList.add('active');
    renameInput.focus();
  }

  function hideRenameModal() {
    renameModal.classList.remove('active');
    overlay.classList.remove('active');
    currentChatBeingRenamed = null;
  }

  function setupEventListeners() {
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      
      if (document.body.classList.contains("dark-mode")) {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        localStorage.setItem("darkMode", "true");
      } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        localStorage.setItem("darkMode", "false");
      }
    });

    chatMenuBtn.addEventListener("click", () => {
      chatSidebar.classList.toggle('hidden');
    });

    mobileMenuBtn.addEventListener("click", () => {
      chatSidebar.classList.toggle('hidden');
    });

    settingsBtn.addEventListener("click", () => {
      settingsPanel.classList.add("active");
      overlay.classList.add("active");
    });

    closeSettings.addEventListener("click", () => {
      settingsPanel.classList.remove("active");
      overlay.classList.remove("active");
      
      for (const chatId in chatHistory) {
        if (chatHistory[chatId].messages.some(msg => msg.role === 'system')) {
          chatHistory[chatId].messages[0].content = systemPromptInput.value;
        }
      }
      
      saveChatHistory();
    });

    overlay.addEventListener("click", () => {
      settingsPanel.classList.remove("active");
      renameModal.classList.remove("active");
      overlay.classList.remove("active");
    });

    clearBtn.addEventListener("click", () => {
      userInput.value = "";
      clearBtn.style.display = "none";
      resetTextareaHeight();
      userInput.focus();
    });

    suggestions.forEach(suggestion => {
      suggestion.addEventListener("click", () => {
        userInput.value = suggestion.textContent;
        chatForm.dispatchEvent(new Event("submit"));
      });
    });

    newChatBtn.addEventListener("click", () => {
      createNewChat();
    });

    renameBtn.addEventListener("click", () => {
      if (currentChatBeingRenamed) {
        renameChat(currentChatBeingRenamed, renameInput.value);
      }
    });

    cancelRenameBtn.addEventListener("click", hideRenameModal);

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const userMessage = userInput.value.trim();
      if (!userMessage) return;
      
      if (!currentChatId || isTemporaryChat) {
        currentChatId = createNewChat();
      }
      
      showMessage(userMessage, "user");
      userInput.value = "";
      clearBtn.style.display = "none";
      resetTextareaHeight();
      
      chatHistory[currentChatId].messages.push({
        role: "user",
        content: userMessage,
        timestamp: new Date().toISOString()
      });
      
      if (chatHistory[currentChatId].messages.length === 1) {
        chatHistory[currentChatId].title = userMessage.slice(0, 30) + (userMessage.length > 30 ? "..." : "");
        saveChatHistory();
      }
      
      await sendMessage(userMessage);
    });

    userInput.addEventListener("input", () => {
      if (userInput.value.trim() !== "") {
        clearBtn.style.display = "flex";
      } else {
        clearBtn.style.display = "none";
      }
      
      userInput.style.height = 'auto';
      userInput.style.height = (userInput.scrollHeight) + 'px';
    });

    function resetTextareaHeight() {
      userInput.style.height = 'auto';
      userInput.style.height = '40px';
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "/" && document.activeElement !== userInput) {
        e.preventDefault();
        userInput.focus();
      }
      
      if (e.key === "Enter" && e.ctrlKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event("submit"));
      }
      
      if (e.key === "Escape") {
        settingsPanel.classList.remove("active");
        renameModal.classList.remove("active");
        overlay.classList.remove("active");
      }
    });

    chatBox.addEventListener("contextmenu", (e) => {
      const messageContent = e.target.closest(".message-content");
      if (messageContent && messageContent.closest(".bot")) {
        e.preventDefault();
        lastRightClickedMessage = messageContent;
        
        contextMenu.style.display = 'block';
        contextMenu.style.left = `${e.pageX}px`;
        contextMenu.style.top = `${e.pageY}px`;
      }
    });

    document.addEventListener("click", () => {
      contextMenu.style.display = 'none';
    });

    readAloudBtn.addEventListener("click", () => {
      if (lastRightClickedMessage) {
        const text = lastRightClickedMessage.innerText
          .replace(/Копирай\n\d{1,2}:\d{1,2}/g, "")
          .replace(/[^\w\sа-яА-Я.,!?;:()-]/g, ""); 
        readMessageAloud(text.trim());
      }
      contextMenu.style.display = 'none';
    });

    setupSpeechRecognition();
  }

  function readMessageAloud(text) {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'bg-BG';
      
      const voices = speechSynthesis.getVoices();
      const ivanVoice = voices.find(voice => 
        voice.name.includes('Ivan') || voice.name.includes('Bulgarian')
      );
      
      if (ivanVoice) {
        utterance.voice = ivanVoice;
      }
      
      speechSynthesis.speak(utterance);
    } else {
      showError("Гласовото възпроизвеждане не се поддържа от вашия браузър");
    }
  }

  function formatTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, "0");
    const minutes = String(now.getMinutes()).padStart(2, "0");
    return `${hours}:${minutes}`;
  }

  function processText(text) {
    text = text.replace(/```([a-z]*)\n([\s\S]*?)```/g, function(match, lang, code) {
      const copyBtn = `<button class="pre-copy-btn"><i class="fas fa-copy"></i></button>`;
      return `<pre><code class="language-${lang}">${copyBtn}${code.trim()}</code></pre>`;
    });
    
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    text = text.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
    
    text = text.replace(/\$(.*?)\$/g, '<span class="math-expression">$1</span>');
    
    text = text.replace(/\n/g, '<br>');
    
    return text;
  }

  function showMessage(message, sender, saveToHistory = true) {
    const processedMessage = processText(message);
    const messageDiv = document.createElement("div");
    messageDiv.className = `message ${sender}`;
    
    const avatar = document.createElement("div");
    avatar.className = `message-avatar ${sender}-avatar`;
    
    if (sender === "user") {
      avatar.innerHTML = '<i class="fas fa-user"></i>';
    } else {
      avatar.innerHTML = '<i class="fas fa-robot"></i>';
    }
    
    const contentWrapper = document.createElement("div");
    contentWrapper.className = "message-content-wrapper";
    
    const content = document.createElement("div");
    content.className = "message-content";
    content.innerHTML = processedMessage;
    
    const timeContainer = document.createElement("div");
    timeContainer.className = "message-time-container";
    
    const time = document.createElement("div");
    time.className = "message-time";
    time.textContent = formatTime();
    
    if (sender === "bot") {
      const copyBtn = document.createElement("button");
      copyBtn.className = "copy-btn tooltip";
      copyBtn.setAttribute("data-tooltip", "Копирай");
      copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
      copyBtn.addEventListener("click", (e) => { 
        e.stopPropagation();
        const messageContent = e.target.closest(".message-content");
        const cleanText = messageContent.innerText
          .replace(/Копирай\n\d{1,2}:\d{1,2}/g, "")
          .trim();
        
        navigator.clipboard.writeText(cleanText).then(() => {
          const originalIcon = copyBtn.innerHTML;
          copyBtn.innerHTML = '<i class="fas fa-check"></i>';
          setTimeout(() => {
            copyBtn.innerHTML = originalIcon;
          }, 1500);
        });
      });
      contentWrapper.appendChild(copyBtn); 
    }
    
    contentWrapper.appendChild(content);
    timeContainer.appendChild(time);
    contentWrapper.appendChild(timeContainer);
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(contentWrapper);
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    if (saveToHistory && currentChatId) {
      chatHistory[currentChatId].messages.push({
        role: sender === "user" ? "user" : "assistant",
        content: message,
        timestamp: new Date().toISOString()
      });
      
      if (!isTemporaryChat) {
        saveChatHistory();
      }
    }
  }

  function setupCopyButtons() {
    document.querySelectorAll(".copy-btn").forEach(btn => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      newBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const messageContent = e.target.closest(".message-content") || 
                              e.target.closest(".message-content-wrapper").querySelector(".message-content");
        const cleanText = messageContent.innerText
          .replace(/Копирай\n\d{1,2}:\d{1,2}/g, "")
          .trim();
        
        navigator.clipboard.writeText(cleanText).then(() => {
          const originalIcon = newBtn.innerHTML;
          newBtn.innerHTML = '<i class="fas fa-check"></i>';
          setTimeout(() => {
            newBtn.innerHTML = originalIcon;
          }, 1500);
        });
      });
    });
    
    document.querySelectorAll(".pre-copy-btn").forEach(btn => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      newBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const codeBlock = e.target.closest("code");
        const code = codeBlock.innerText.replace('Копирай', '').trim();
        
        navigator.clipboard.writeText(code).then(() => {
          const originalIcon = newBtn.innerHTML;
          newBtn.innerHTML = '<i class="fas fa-check"></i>';
          setTimeout(() => {
            newBtn.innerHTML = originalIcon;
          }, 1500);
        });
      });
    });
  }

  function showLoadingIndicator() {
    const loadingDiv = document.createElement("div");
    loadingDiv.className = "loading-wave";
    loadingDiv.innerHTML = `
      <div class="loading-wave-dot"></div>
      <div class="loading-wave-dot"></div>
      <div class="loading-wave-dot"></div>
    `;
    chatBox.appendChild(loadingDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    return loadingDiv;
  }

  function hideLoadingIndicator(loadingDiv) {
    if (loadingDiv && loadingDiv.parentNode) {
      loadingDiv.parentNode.removeChild(loadingDiv);
    }
  }

  function showTypingIndicator() {
    typingIndicator.style.display = "block";
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function hideTypingIndicator() {
    typingIndicator.style.display = "none";
  }

  async function sendMessage(userMessage) {
    if (!chatHistory[currentChatId].messages.some(msg => msg.role === 'system')) {
      chatHistory[currentChatId].messages.unshift({
        role: "system",
        content: systemPromptInput.value
      });
    }
    
    showTypingIndicator();
    sendButton.disabled = true;
    
    const loadingIndicator = showLoadingIndicator();
    
    try {
      const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${API_KEY}`,
          "HTTP-Referer": "http://localhost",
          "X-Title": "vesko-ai-chat"
        },
        body: JSON.stringify({
          model: "deepseek/deepseek-chat",
          messages: chatHistory[currentChatId].messages,
          stream: true
        })
      });
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: { message: "Непозната грешка" } }));
        throw new Error(errorData.error?.message || "Грешка при свързване с AI сървъра");
      }
      
      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let botMessage = "";
      let partialData = "";
      
      hideTypingIndicator();
      hideLoadingIndicator(loadingIndicator);
      
      const botMessageDiv = document.createElement("div");
      botMessageDiv.className = "message bot";
      
      const botAvatar = document.createElement("div");
      botAvatar.className = "message-avatar bot-avatar";
      botAvatar.innerHTML = '<i class="fas fa-robot"></i>';
      
      const contentWrapper = document.createElement("div");
      contentWrapper.className = "message-content-wrapper";
      
      const botContent = document.createElement("div");
      botContent.className = "message-content";
      
      const timeContainer = document.createElement("div");
      timeContainer.className = "message-time-container";
      
      const botTime = document.createElement("div");
      botTime.className = "message-time";
      botTime.textContent = formatTime();
      
      const copyBtn = document.createElement("button");
      copyBtn.className = "copy-btn tooltip";
      copyBtn.setAttribute("data-tooltip", "Копирай");
      copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
      copyBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const messageContent = e.target.closest(".message-content") || 
                              e.target.closest(".message-content-wrapper").querySelector(".message-content");
        const cleanText = messageContent.innerText
          .replace(/Копирай\n\d{1,2}:\d{1,2}/g, "")
          .trim();
        
        navigator.clipboard.writeText(cleanText).then(() => {
          const originalIcon = copyBtn.innerHTML;
          copyBtn.innerHTML = '<i class="fas fa-check"></i>';
          setTimeout(() => {
            copyBtn.innerHTML = originalIcon;
          }, 1500);
        });
      });
      
      contentWrapper.appendChild(copyBtn); 
      contentWrapper.appendChild(botContent);
      timeContainer.appendChild(botTime);
      contentWrapper.appendChild(timeContainer);
      
      botMessageDiv.appendChild(botAvatar);
      botMessageDiv.appendChild(contentWrapper);
      
      chatBox.appendChild(botMessageDiv);
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value, { stream: true });
        partialData += chunk;
        
        let jsonStartPos;
        while ((jsonStartPos = partialData.indexOf('data: ')) !== -1) {
          const jsonEndPos = partialData.indexOf('\n', jsonStartPos);
          if (jsonEndPos === -1) break; 
          
          const jsonString = partialData.substring(jsonStartPos + 6, jsonEndPos).trim();
          if (jsonString === '[DONE]') {
            partialData = partialData.substring(jsonEndPos + 1);
            continue;
          }
          
          try {
            const data = JSON.parse(jsonString);
            const content = data.choices[0]?.delta?.content || "";
            
            if (content) {
              botMessage += content;
              botContent.innerHTML = processText(botMessage);
              chatBox.scrollTop = chatBox.scrollHeight;
            }
          } catch (e) {
            console.error("Error parsing JSON:", e);
          }
          
          partialData = partialData.substring(jsonEndPos + 1);
        }
      }
      
      chatHistory[currentChatId].messages.push({
        role: "assistant",
        content: botMessage,
        timestamp: new Date().toISOString()
      });
      
      if (!isTemporaryChat) {
        saveChatHistory();
      }
      
      setupCopyButtons();
      
    } catch (err) {
      console.error("API Error:", err);
      hideTypingIndicator();
      hideLoadingIndicator(loadingIndicator);
      showError(`Грешка: ${err.message}`);
    } finally {
      sendButton.disabled = false;
    }
  }

  function showError(message) {
    const errorDiv = document.createElement("div");
    errorDiv.className = "error-message";
    errorDiv.textContent = message;
    chatBox.appendChild(errorDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    setTimeout(() => {
      errorDiv.remove();
    }, 5000);
  }

  let recognition;
  let isListening = false;

  function setupSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      voiceButton.disabled = true;
      voiceButton.setAttribute("data-tooltip", "Гласовото въвеждане не се поддържа");
      return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'bg-BG';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      userInput.value = transcript;
      stopListening();
    };
    
    recognition.onerror = (event) => {
      console.error("Speech recognition error", event.error);
      stopListening();
      showError(`Грешка при гласово въвеждане: ${event.error}`);
    };
    
    recognition.onend = () => {
      stopListening();
    };
  }

  function startListening() {
    if (!recognition) setupSpeechRecognition();
    if (!recognition || isListening) return;
    
    try {
      recognition.start();
      isListening = true;
      voiceButton.classList.add("speech-recognition-active");
      voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
    } catch (err) {
      console.error("Error starting speech recognition:", err);
      showError("Не можем да стартираме гласово въвеждане");
    }
  }
  
  function stopListening() {
    if (!isListening) return;
    
    try {
      recognition.stop();
    } catch (err) {
      console.error("Error stopping speech recognition:", err);
    }
    
    isListening = false;
    voiceButton.classList.remove("speech-recognition-active");
    voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
  }

  voiceButton.addEventListener("click", () => {
    if (isListening) {
      stopListening();
    } else {
      startListening();
    }
  });

  init();
    </script>
</body>
</html>